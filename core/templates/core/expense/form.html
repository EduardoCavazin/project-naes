{% extends "core/models/form_base.html" %}
{% load crispy_forms_tags %}

{% block form_title %}{{ titulo }}{% endblock form_title %}
{% block form_subtitle %}
  <p class="text-muted">Informe os dados da sua despesa</p>
{% endblock form_subtitle %}

{% block form_fields %}
  {{ form|crispy }}
  
  <div id="installments_div" class="mb-3" style="display: none;">
    <label for="id_installments" class="form-label">Número de Parcelas</label>
    <input type="number" class="form-control" id="id_installments" name="installments" min="1" value="1">
    <div class="form-text">Selecione em quantas parcelas deseja dividir esta despesa.</div>
  </div>
{% endblock form_fields %}

{% block form_specific_js %}
  const paymentMethodSelect = document.getElementById('id_payment_method');
  const installmentsDiv = document.getElementById('installments_div');
  const installmentsInput = document.getElementById('id_installments');
  
  // Inicialmente ocultar o campo de parcelas
  if (installmentsDiv) {
    installmentsDiv.style.display = 'none';
  }
  
  if (paymentMethodSelect && installmentsDiv && installmentsInput) {
    const installmentMethodsData = JSON.parse(paymentMethodSelect.getAttribute('data-installment-methods') || '{}');
    console.log('Installment methods data:', installmentMethodsData);
    
    function updateInstallmentsVisibility() {
      const selectedId = paymentMethodSelect.value;
      console.log('Selected payment method ID:', selectedId);
      
      if (selectedId && installmentMethodsData[selectedId]) {
        const methodData = installmentMethodsData[selectedId];
        console.log('Method data:', methodData);
        
        if (methodData.supports) {
          installmentsDiv.style.display = 'block';
          const maxInstallments = methodData.max || 1;
          installmentsInput.max = maxInstallments;
          
          // Atualizar placeholder e helper text
          const helpText = installmentsDiv.querySelector('.form-text');
          if (helpText) {
            helpText.textContent = `Selecione de 1 até ${maxInstallments} parcelas.`;
          }
          
          // Validar valor atual
          const currentValue = parseInt(installmentsInput.value) || 1;
          if (currentValue > maxInstallments) {
            installmentsInput.value = maxInstallments;
          }
        } else {
          installmentsDiv.style.display = 'none';
          installmentsInput.value = 1;
        }
      } else {
        installmentsDiv.style.display = 'none';
        installmentsInput.value = 1;
      }
    }
    
    // Executar na inicialização
    updateInstallmentsVisibility();
    
    // Executar quando mudar seleção
    paymentMethodSelect.addEventListener('change', updateInstallmentsVisibility);
  }
{% endblock form_specific_js %}
