{% extends "core/models/form_base.html" %}
{% load crispy_forms_tags %}

{% block form_title %}{{ titulo }}{% endblock form_title %}
{% block form_subtitle %}
  <p class="text-muted">Informe os dados da sua despesa</p>
{% endblock form_subtitle %}

{% block form_fields %}
  {{ form|crispy }}
  
  <div id="installments_div" class="mb-3" style="display: none;">
    <label for="id_installments" class="form-label">NÃºmero de Parcelas</label>
    <input type="number" class="form-control" id="id_installments" name="installments" min="1" value="1">
    <div class="form-text">Selecione em quantas parcelas deseja dividir esta despesa.</div>
  </div>
{% endblock form_fields %}

{% block form_specific_js %}
  const paymentMethodSelect = document.getElementById('id_payment_method');
  const installmentsDiv = document.getElementById('installments_div');
  const installmentsInput = document.getElementById('id_installments');
  
  if (paymentMethodSelect) {
    const installmentMethodsData = JSON.parse(paymentMethodSelect.getAttribute('data-installment-methods') || '{}');
    
    function updateInstallmentsVisibility() {
      const selectedId = paymentMethodSelect.value;
      if (selectedId && installmentMethodsData[selectedId] && installmentMethodsData[selectedId].supports) {
        installmentsDiv.style.display = 'block';
        const maxInstallments = installmentMethodsData[selectedId].max;
        installmentsInput.max = maxInstallments;
        if (parseInt(installmentsInput.value) > maxInstallments) {
          installmentsInput.value = maxInstallments;
        }
      } else {
        installmentsDiv.style.display = 'none';
        installmentsInput.value = 1;
      }
    }
    
    updateInstallmentsVisibility();
    
    paymentMethodSelect.addEventListener('change', updateInstallmentsVisibility);
  }
{% endblock form_specific_js %}
