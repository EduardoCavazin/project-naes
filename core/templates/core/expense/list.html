{% extends "core/models/list_base.html" %}
{% load static %}

{% block title %}Lista de Despesas{% endblock %}

{% block page_icon %}receipt{% endblock %}
{% block page_description %}Gerencie suas despesas financeiras{% endblock %}

{% block extra_head %}
{{ block.super }}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
{% endblock %}

{% block filters %}
<!-- Filtros Client-Side Customizados -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
        <i class="fas fa-filter me-2"></i>Filtros AvanÃ§ados
      </button>
    </h5>
  </div>
  
  <div class="collapse" id="filterCollapse">
    <div class="card-body">
      <div class="row g-3">
        <!-- Busca Global -->
        <div class="col-12">
          <label class="form-label"><i class="fas fa-search me-1"></i>Busca Global</label>
          <input type="text" class="form-control" id="globalSearch" placeholder="Digite qualquer palavra para buscar...">
        </div>
        
        <!-- Filtros EspecÃ­ficos -->
        <div class="col-md-4">
          <label class="form-label"><i class="fas fa-tag me-1"></i>Categoria</label>
          <select class="form-select" id="categoryFilter">
            <option value="">Todas as categorias</option>
            {% for category in categories %}
            <option value="{{ category.name }}">{{ category.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-4">
          <label class="form-label"><i class="fas fa-dollar-sign me-1"></i>Valor MÃ­nimo</label>
          <input type="text" class="form-control money-field" id="valueMin" placeholder="R$ 0,00">
        </div>
        
        <div class="col-md-4">
          <label class="form-label"><i class="fas fa-dollar-sign me-1"></i>Valor MÃ¡ximo</label>
          <input type="text" class="form-control money-field" id="valueMax" placeholder="R$ 0,00">
        </div>
        
        <div class="col-md-6">
          <label class="form-label"><i class="fas fa-calendar me-1"></i>Data Inicial</label>
          <input type="date" class="form-control" id="dateFrom">
        </div>
        
        <div class="col-md-6">
          <label class="form-label"><i class="fas fa-calendar me-1"></i>Data Final</label>
          <input type="date" class="form-control" id="dateTo">
        </div>
        
        <!-- BotÃµes -->
        <div class="col-12">
          <button type="button" class="btn btn-primary" id="applyFilters">
            <i class="fas fa-search me-1"></i>Aplicar Filtros
          </button>
          <button type="button" class="btn btn-outline-secondary" id="clearFilters">
            <i class="fas fa-times me-1"></i>Limpar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block table_headers %}
<th><i class="fas fa-file-alt me-1"></i>DescriÃ§Ã£o</th>
<th><i class="fas fa-calendar me-1"></i>Data</th>
<th><i class="fas fa-dollar-sign me-1"></i>Valor</th>
<th><i class="fas fa-tags me-1"></i>Categoria</th>
<th><i class="fas fa-credit-card me-1"></i>Pagamento</th>
<th><i class="fas fa-university me-1"></i>Conta</th>
<th><i class="fas fa-cogs me-1"></i>AÃ§Ãµes</th>
{% endblock %}

{% block table_row %}
<td>{{ obj.name }}</td>
<td>{{ obj.date|date:"d/m/Y" }}</td>
<td data-order="{{ obj.value }}">R$ {{ obj.value|floatformat:2 }}</td>
<td>{{ obj.category.name }}</td>
<td>{{ obj.payment_method.name }}</td>
<td>{{ obj.account.name }}</td>
<td>
  <div class="btn-group btn-group-sm" role="group">
    <a href="{% url 'expense-update' obj.pk %}" class="btn btn-outline-primary" title="Editar">
      <i class="fas fa-edit"></i>
    </a>
    <a href="{% url 'expense-delete' obj.pk %}" class="btn btn-outline-danger" title="Excluir">
      <i class="fas fa-trash"></i>
    </a>
  </div>
</td>
{% endblock %}

{% block empty_colspan %}7{% endblock %}
{% block empty_icon %}receipt{% endblock %}
{% block empty_message %}Nenhuma despesa encontrada{% endblock %}
{% block empty_description %}Comece adicionando uma nova despesa{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
<script src="{% static 'js/datatables-config.js' %}"></script>

<script>
$(document).ready(function() {
    console.log('âœ… Despesas - Filtros Client-Side carregados!');
    
    // Aplicar DataTables manualmente
    const table = $('table').DataTable({
        pageLength: 25,
        responsive: true,
        language: {
            "sProcessing": "Processando...",
            "sLengthMenu": "Mostrar _MENU_ registros",
            "sZeroRecords": "Nenhum registro encontrado",
            "sInfo": "Mostrando de _START_ atÃ© _END_ de _TOTAL_ registros",
            "sInfoEmpty": "Mostrando de 0 atÃ© 0 de 0 registros",
            "sInfoFiltered": "(filtrado de _MAX_ registros no total)",
            "sSearch": "Buscar:",
            "oPaginate": {
                "sNext": "PrÃ³ximo",
                "sPrevious": "Anterior",
                "sFirst": "Primeiro",
                "sLast": "Ãšltimo"
            }
        },
        order: [[1, 'desc']], // Data decrescente
    });
    
    // Aplicar mÃ¡scaras monetÃ¡rias
    $('.money-field').mask('#.##0,00', {
        reverse: true,
        placeholder: '0,00',
        translation: {
            '#': {pattern: /[0-9]/, optional: true}
        }
    });
    
    // Filtro global
    $('#globalSearch').on('keyup', function() {
        table.search(this.value).draw();
    });
    
    // Filtro por categoria
    $('#categoryFilter').on('change', function() {
        const val = $(this).val();
        table.column(3).search(val ? '^' + val + '$' : '', true, false).draw();
    });
    
    // Filtros personalizados de valor
    function filterByValue() {
        const min = parseFloat($('#valueMin').val().replace(/\./g, '').replace(',', '.')) || 0;
        const max = parseFloat($('#valueMax').val().replace(/\./g, '').replace(',', '.')) || 999999999;
        
        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
            const value = parseFloat(data[2].replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            return value >= min && value <= max;
        });
        
        table.draw();
        $.fn.dataTable.ext.search.pop();
    }
    
    // Filtros de data
    function filterByDate() {
        const dateFrom = $('#dateFrom').val();
        const dateTo = $('#dateTo').val();
        
        if (dateFrom || dateTo) {
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                const dateStr = data[1];
                const dateParts = dateStr.split('/');
                const date = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                
                const from = dateFrom ? new Date(dateFrom) : new Date('1900-01-01');
                const to = dateTo ? new Date(dateTo) : new Date('2100-01-01');
                
                return date >= from && date <= to;
            });
            
            table.draw();
            $.fn.dataTable.ext.search.pop();
        }
    }
    
    // Eventos dos filtros
    $('#valueMin, #valueMax').on('keyup change', filterByValue);
    $('#dateFrom, #dateTo').on('change', filterByDate);
    
    // Aplicar todos os filtros
    $('#applyFilters').on('click', function() {
        filterByValue();
        filterByDate();
        
        // Feedback visual
        $(this).html('<i class="fas fa-check me-1"></i>Aplicado!').removeClass('btn-primary').addClass('btn-success');
        setTimeout(() => {
            $(this).html('<i class="fas fa-search me-1"></i>Aplicar Filtros').removeClass('btn-success').addClass('btn-primary');
        }, 2000);
    });
    
    // Limpar filtros
    $('#clearFilters').on('click', function() {
        $('#globalSearch, #valueMin, #valueMax, #dateFrom, #dateTo').val('');
        $('#categoryFilter').val('');
        table.search('').columns().search('').draw();
        
        // Feedback
        $(this).html('<i class="fas fa-check me-1"></i>Limpo!').removeClass('btn-outline-secondary').addClass('btn-outline-success');
        setTimeout(() => {
            $(this).html('<i class="fas fa-times me-1"></i>Limpar').removeClass('btn-outline-success').addClass('btn-outline-secondary');
        }, 1500);
    });
    
    console.log('ðŸŽ¯ Filtros de despesas configurados com sucesso!');
});
</script>
{% endblock %}